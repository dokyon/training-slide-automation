# 🚀 ナレーション生成アプリ - デプロイ手順書

## 📋 目次

1. [事前準備](#事前準備)
2. [初回セットアップ](#初回セットアップ)
3. [デプロイ方法](#デプロイ方法)
4. [動作確認](#動作確認)
5. [メンテナンス](#メンテナンス)
6. [トラブルシューティング](#トラブルシューティング)

---

## 🔧 事前準備

### 必要なソフトウェア

デプロイには以下のソフトウェアが必要です：

#### 1. Docker Desktop のインストール

**Mac の場合:**

1. [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop/) をダウンロード
2. ダウンロードした `.dmg` ファイルを開く
3. Docker.app を Applications フォルダにドラッグ
4. Docker Desktop を起動
5. 初回起動時の設定を完了

**Windows の場合:**

1. [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/) をダウンロード
2. インストーラーを実行
3. WSL 2 のインストールを求められた場合は指示に従う
4. Docker Desktop を起動

**インストール確認:**

ターミナル（またはコマンドプロンプト）で以下を実行：

```bash
docker --version
docker-compose --version
```

正常にバージョンが表示されればOKです。

---

## 🎯 初回セットアップ

### ステップ1: プロジェクトフォルダに移動

```bash
cd /Users/dosakakyohei/dev/training-slide-automation
```

### ステップ2: 環境変数ファイルの作成

```bash
cp .env.example .env
```

### ステップ3: APIキーの設定

`.env` ファイルをテキストエディタで開き、以下を設定：

```bash
# 必須: Gemini API Key
GEMINI_API_KEY=your_actual_gemini_api_key_here

# 推奨: 有料プランを使用（高速・無制限）
GEMINI_PAID_TIER=true
```

**Gemini API Keyの取得方法:**

1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. 「Get API Key」をクリック
4. 生成されたキーをコピーして `.env` に貼り付け

### ステップ4: 有料プラン vs 無料プラン

| 項目 | 無料プラン | 有料プラン（推奨） |
|------|-----------|------------------|
| リクエスト制限 | 15回/日 | 無制限 |
| 処理速度 | 約35秒/音声 | 約3-5秒/音声 |
| コスト | 0円 | 約2円/音声 |

**推奨設定:**

```bash
# 高速・無制限が必要な場合
GEMINI_PAID_TIER=true

# 少量のテストのみの場合
GEMINI_PAID_TIER=false
```

---

## 🚀 デプロイ方法

### 方法1: 自動デプロイスクリプト（推奨）

最も簡単な方法です：

```bash
./deploy.sh
```

このスクリプトは以下を自動で実行します：

1. ✅ 環境変数ファイルの確認
2. ✅ 既存コンテナの停止・削除
3. ✅ Dockerイメージのビルド
4. ✅ コンテナの起動
5. ✅ ヘルスチェック

**成功時の出力:**

```
🎉 デプロイ完了！

📍 アプリケーションURL: http://localhost:3000
📂 音声ファイル保存先: ./output/narration/
```

### 方法2: 手動デプロイ

細かく制御したい場合：

```bash
# 1. 既存コンテナの停止
docker-compose down

# 2. イメージのビルド
docker-compose build

# 3. コンテナの起動
docker-compose up -d

# 4. ログの確認
docker-compose logs -f
```

---

## ✅ 動作確認

### 1. コンテナの状態確認

```bash
docker-compose ps
```

**正常な出力例:**

```
NAME                    STATUS              PORTS
narration-generator     Up 30 seconds       0.0.0.0:3000->3000/tcp
```

### 2. ヘルスチェック

```bash
curl http://localhost:3000/api/health
```

**正常な出力:**

```json
{"status":"ok","paid":true}
```

### 3. ブラウザで確認

1. ブラウザで以下のURLを開く：

```
http://localhost:3000
```

2. 画面上部に以下が表示されればOK：
   - ✅ **正常動作中**（緑色）
   - **有料プラン** または **無料プラン**
   - **音声ファイルの保存先**

### 4. テスト音声の生成

1. テキスト入力欄に以下を入力：

```
これはテストです。正常に音声が生成されることを確認します。
```

2. 「🎙️ 音声を生成する」ボタンをクリック
3. 数秒後、以下が表示されればOK：
   - ✅ 音声生成完了！
   - ファイル名、サイズ、保存先
   - ダウンロードボタン

---

## 🔧 メンテナンス

### コンテナの再起動

設定変更後やエラー時：

```bash
docker-compose restart
```

### コンテナの停止

アプリを一時的に止める：

```bash
docker-compose stop
```

### コンテナの起動

停止したコンテナを再開：

```bash
docker-compose start
```

### コンテナの完全削除

すべてのデータを削除してやり直す：

```bash
docker-compose down -v
```

⚠️ **注意:** 保存された音声ファイルは `./output/narration/` に残りますが、設定は削除されます。

### ログの確認

リアルタイムでログを表示：

```bash
docker-compose logs -f
```

特定の行数のみ表示：

```bash
docker-compose logs --tail=100
```

### ディスク容量の確認

Dockerが使用している容量を確認：

```bash
docker system df
```

不要なイメージ・コンテナの削除：

```bash
docker system prune -a
```

---

## 🐛 トラブルシューティング

### ❌ エラー: "Cannot connect to the Docker daemon"

**原因:** Docker Desktop が起動していない

**解決方法:**

1. Docker Desktop を起動
2. Docker アイコンがメニューバーに表示されるまで待つ
3. 再度デプロイを実行

---

### ❌ エラー: "port 3000 is already allocated"

**原因:** ポート3000が既に使用されている

**解決方法:**

#### 方法1: 既存のコンテナを停止

```bash
docker-compose down
```

#### 方法2: 使用中のプロセスを確認

```bash
# Mac/Linux
lsof -i :3000

# Windows
netstat -ano | findstr :3000
```

#### 方法3: ポート番号を変更

`docker-compose.yml` を編集：

```yaml
ports:
  - "3001:3000"  # 3000 → 3001 に変更
```

その後、`http://localhost:3001` でアクセス

---

### ❌ エラー: "GEMINI_API_KEY is not set"

**原因:** 環境変数が正しく設定されていない

**解決方法:**

1. `.env` ファイルが存在するか確認：

```bash
ls -la .env
```

2. `.env` の内容を確認：

```bash
cat .env | grep GEMINI_API_KEY
```

3. APIキーが正しく設定されているか確認
4. コンテナを再起動：

```bash
docker-compose restart
```

---

### ❌ エラー: "音声生成に失敗しました"

**原因1:** APIキーが無効

**解決方法:**

1. [Google AI Studio](https://makersuite.google.com/app/apikey) で新しいAPIキーを生成
2. `.env` を更新
3. コンテナを再起動

**原因2:** API制限（無料プラン）

**解決方法:**

1. 翌日まで待つ
2. または有料プランに切り替え：

```bash
# .env を編集
GEMINI_PAID_TIER=true
```

3. コンテナを再起動

**原因3:** ネットワークエラー

**解決方法:**

1. インターネット接続を確認
2. ファイアウォール設定を確認
3. プロキシ環境の場合は設定を確認

---

### ❌ ヘルスチェック失敗

**原因:** コンテナが正常に起動していない

**解決方法:**

1. ログを確認：

```bash
docker-compose logs
```

2. コンテナの状態を確認：

```bash
docker-compose ps
```

3. コンテナを再ビルド：

```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

---

### ❌ 音声ファイルが保存されない

**原因:** ボリュームマウントの問題

**解決方法:**

1. `docker-compose.yml` でボリューム設定を確認：

```yaml
volumes:
  - ./output:/app/output
```

2. `output` ディレクトリが存在するか確認：

```bash
ls -la output/
```

3. 存在しない場合は作成：

```bash
mkdir -p output/narration
```

4. コンテナを再起動：

```bash
docker-compose restart
```

---

## 📊 監視とメトリクス

### コンテナのリソース使用状況

```bash
docker stats narration-generator
```

**表示される情報:**

- CPU使用率
- メモリ使用量
- ネットワークI/O
- ディスクI/O

### コンテナの詳細情報

```bash
docker inspect narration-generator
```

---

## 🔄 アップデート手順

新しいバージョンにアップデートする場合：

```bash
# 1. コードを最新版に更新（git pullなど）
git pull origin main

# 2. 既存コンテナを停止
docker-compose down

# 3. 新しいイメージをビルド
docker-compose build --no-cache

# 4. コンテナを起動
docker-compose up -d

# 5. 動作確認
curl http://localhost:3000/api/health
```

---

## 🌐 本番環境デプロイ（参考）

### AWS EC2 での例

```bash
# 1. EC2インスタンスにSSH接続
ssh -i your-key.pem ec2-user@your-ec2-ip

# 2. Dockerのインストール
sudo yum update -y
sudo yum install -y docker
sudo service docker start

# 3. docker-composeのインストール
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 4. プロジェクトをクローン
git clone your-repository
cd training-slide-automation

# 5. 環境変数を設定
cp .env.example .env
nano .env  # APIキーを設定

# 6. デプロイ
./deploy.sh
```

### セキュリティ設定

本番環境では以下を設定してください：

1. **ファイアウォール設定**
   - ポート3000へのアクセスを制限
   - 必要なIPアドレスのみ許可

2. **HTTPS対応**
   - リバースプロキシ（Nginx, Apache）の設置
   - SSL証明書の設定（Let's Encrypt推奨）

3. **認証の追加**
   - Basic認証
   - OAuth2認証
   - IPホワイトリスト

---

## 📞 サポート

### よくある質問

**Q: Dockerを使わずにデプロイできますか？**

A: はい、可能です。以下のコマンドで直接実行できます：

```bash
npm install
npm run build
npm run app
```

ただし、ffmpegのインストールが別途必要です。

**Q: Windowsで動きますか？**

A: はい、Docker Desktop for Windows をインストールすれば動作します。

**Q: 複数のユーザーが同時に使用できますか？**

A: はい、Webアプリケーションなので複数ユーザーの同時利用が可能です。

---

## ✅ デプロイチェックリスト

デプロイ前に確認：

- [ ] Docker Desktop がインストール済み
- [ ] `.env` ファイルが作成済み
- [ ] `GEMINI_API_KEY` が正しく設定されている
- [ ] `GEMINI_PAID_TIER` が設定されている
- [ ] インターネット接続が正常

デプロイ後に確認：

- [ ] コンテナが起動している（`docker-compose ps`）
- [ ] ヘルスチェックが成功（`curl http://localhost:3000/api/health`）
- [ ] ブラウザでアクセス可能（`http://localhost:3000`）
- [ ] テスト音声が生成できる
- [ ] 音声ファイルが保存されている

---

## 🎉 まとめ

### 基本的なデプロイフロー

```bash
# 1. セットアップ（初回のみ）
cp .env.example .env
# .env を編集してAPIキーを設定

# 2. デプロイ
./deploy.sh

# 3. 確認
open http://localhost:3000
```

### 日常的な運用

```bash
# 起動
docker-compose start

# 停止
docker-compose stop

# 再起動
docker-compose restart

# ログ確認
docker-compose logs -f
```

---

✨ **簡単・安全・確実** - Dockerで本番環境も開発環境も同じように動作します
